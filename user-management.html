<!doctype html><html lang="ms"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<base href="./">
<link rel="icon" type="image/png" href="./assets/favicon.png">
<link rel="stylesheet" href="./css/style.css">
<link rel="stylesheet" href="./css/theme.css"><title>User Management – KB-JPS</title></head><body>
<div id="header"></div>
<div class="container">
<div class="grid"><div class="col-12 card form">
  <div class="btnrow"><a class="btn secondary" href="./menu.html">← Dashboard</a></div>
  <h2>User Management</h2><p>Demo offline: SUPERADMIN/ADMIN boleh ACTIVE-kan STAFF PENDING.</p>

  <div class="field"><label>Carian</label><input class="input" id="q" placeholder="Cari nama / emel"></div>

  <div style="overflow:auto;margin-top:10px">
    <table class="table" id="t">
      <thead><tr><th>Nama</th><th>Emel</th><th>Role</th><th>Status</th><th>Tindakan</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div></div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const { auth, users, ui, dom } = window.KBJPS;
  const sess = auth.session(); if(!sess) return;
  const role = String(sess.role||'').toUpperCase();
  if(!['SUPERADMIN','ADMIN'].includes(role)){
    ui.toast('Akses ditolak. Hanya ADMIN/SUPERADMIN.', 'err');
    setTimeout(()=>location.href='./menu.html', 700);
    return;
  }

  const tb = document.querySelector('#t tbody');
  const q = document.getElementById('q');

  function render(){
    const term=(q.value||'').toLowerCase();
    const list=users.all().filter(u=>{
      const s=(u.name+' '+u.email+' '+u.role+' '+(u.status||'')).toLowerCase();
      return !term || s.includes(term);
    });

    tb.innerHTML = list.map(u=>{
      const canAct = u.email !== 'superadmin@superadmin.com';
      const btns = (canAct && role==='SUPERADMIN') ? `
        <button class="btn secondary" data-act="ACTIVE" data-email="${dom.esc(u.email)}">ACTIVE</button>
        <button class="btn danger" data-act="INACTIVE" data-email="${dom.esc(u.email)}">INACTIVE</button>
      ` : (canAct && role==='ADMIN') ? `
        <button class="btn secondary" data-act="ACTIVE" data-email="${dom.esc(u.email)}">ACTIVE</button>
      ` : `<span class="pill">Locked</span>`;

      return `<tr>
        <td>${dom.esc(u.name||'')}</td>
        <td>${dom.esc(u.email||'')}</td>
        <td><b>${dom.esc(u.role||'')}</b></td>
        <td>${dom.esc(u.status||'ACTIVE')}</td>
        <td>${btns}</td>
      </tr>`;
    }).join('') || `<tr><td colspan="5" style="color:var(--muted)">Tiada user.</td></tr>`;

    document.querySelectorAll('[data-act]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const email = btn.getAttribute('data-email');
        const st = btn.getAttribute('data-act');
        const r = users.setStatus(email, st);
        if(!r.ok){ ui.toast(r.message||'Gagal', 'err'); return; }
        ui.toast(`Status ${email} => ${st}`, 'ok');
        render();
      });
    });
  }

  q.addEventListener('input', render);
  render();
});
</script>
</div>
<div id="footer"></div>
<script src="./js/utils.js" defer></script>
<script src="./js/script.js" defer></script>

</body></html>